version: 2.1

parameters:
  terraform_version:
    default: "1.7.4"
    type: string

orbs:
  terraform: circleci/terraform@3.2.1

environment: &default_environment
  WORKSPACE: << parameters.workspace >>

commands:
  set_env_vars:
    steps:
      - run:
          name: Configure test cluster env
          command: |
            echo export TF_VAR_deploy_id=\"${WORKSPACE}\" >> $BASH_ENV
            echo 'export TF_VAR_description="CircleCI Build for ${CIRCLE_PR_REPONAME}: ${CIRCLE_BUILD_URL}"' >> $BASH_ENV
            echo 'export WORKSPACE=azure-aks-circleci-${CIRCLE_BUILD_NUM}' >> $BASH_ENV
  update_package_lists:
    steps:
      - run:
          name: Update package lists
          command: |
            # Update package lists before installing (only update, not upgrade)
            if [[ $EUID == 0 ]]; then
              SUDO=""
            else
              SUDO="sudo"
            fi

            if command -v tdnf &> /dev/null; then
              # Azure Linux 3.0 (mcr.microsoft.com/azure-cli image)
              echo "Updating tdnf package lists (Azure Linux 3.0)"
              $SUDO tdnf update --refresh -y || true
            elif command -v apt-get &> /dev/null; then
              # Debian/Ubuntu (cimg/python image)
              echo "Updating apt-get package lists (Debian/Ubuntu)"
              $SUDO apt-get update
            else
              echo "No supported package manager found (tdnf or apt-get)"
              exit 1
            fi
  install_package:
    parameters:
      package_name:
        type: string
    steps:
      - run:
          name: Install << parameters.package_name >>
          command: |
            if ! command -v << parameters.package_name >> &> /dev/null; then
              # Determine if we need sudo (not running as root)
              if [[ $EUID == 0 ]]; then
                SUDO=""
              else
                SUDO="sudo"
              fi

              if command -v tdnf &> /dev/null; then
                # Azure Linux 3.0 (mcr.microsoft.com/azure-cli image)
                echo "Using tdnf to install << parameters.package_name >> (Azure Linux 3.0)"
                $SUDO tdnf install -y << parameters.package_name >>
              elif command -v apt-get &> /dev/null; then
                # Debian/Ubuntu (cimg/python image)
                echo "Using apt-get to install << parameters.package_name >> (Debian/Ubuntu)"
                $SUDO apt-get install -y << parameters.package_name >>
              else
                echo "No supported package manager found for << parameters.package_name >>"
                exit 1
              fi
            else
              echo "<< parameters.package_name >> is already installed"
            fi
  install_dependencies:
    steps:
      - update_package_lists
      - install_package:
          package_name: awk
      - install_package:
          package_name: curl
      - install_package:
          package_name: jq
      - install_package:
          package_name: unzip
      - install_package:
          package_name: wget
  install_terraform:
    parameters:
      terraform_version:
        type: string
        default: << pipeline.parameters.terraform_version >>
    steps:
      - terraform/install:
          terraform_version: << parameters.terraform_version >>
  tf_init_apply:
    steps:
      - run:
          name: Terraform init/validate/apply
          working_directory: tests
          command: |
            echo "Current dir: $(pwd)"
            terraform init
            terraform validate
            terraform workspace new ${WORKSPACE}
            terraform apply -auto-approve
  tf_destroy:
    steps:
      - run:
          name: Terraform destroy
          working_directory: tests
          command: |
            echo "Current dir: $(pwd)"
            terraform destroy --auto-approve || terraform destroy --auto-approve --refresh=false
          when: always
  tf_ws_delete:
    steps:
      - run:
          name: Terraform workspace delete
          working_directory: tests
          command: |
            echo "Current dir: $(pwd)"
            terraform workspace select default
            terraform workspace delete ${WORKSPACE}
          when: always

jobs:
  pre-commit:
    docker:
      - image: cimg/python:3.11.1
    parameters:
      terraform_version:
        type: string
      workspace:
        type: string
        default: ci-<< pipeline.number >>
    environment: *default_environment

    steps:
      - checkout
      - install_dependencies
      - install_terraform
      - run:
          name: pre-commit
          command: |
            curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
            curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
            curl -L https://github.com/terraform-docs/terraform-docs/releases/download/v0.16.0/terraform-docs-v0.16.0-linux-amd64.tar.gz | tar -C /tmp -xzf - && chmod +x /tmp/terraform-docs && sudo mv /tmp/terraform-docs /usr/local/bin
            pip3 install checkov pre-commit
            SKIP=no-commit-to-branch pre-commit run --all-files

  test-deploy:
    docker:
      - image: mcr.microsoft.com/azure-cli
    parameters:
      terraform_version:
        type: string
      workspace:
        type: string
        default: ci-<< pipeline.number >>
    environment: *default_environment
    steps:
      - checkout
      - install_dependencies
      - install_terraform
      - set_env_vars
      - tf_init_apply
      - run:
          name: Check drift
          working_directory: tests
          command: |
            terraform plan -detailed-exitcode
      - tf_destroy
      - tf_ws_delete

  test-upgrade:
    docker:
      - image: mcr.microsoft.com/azure-cli
    parameters:
      workspace:
        type: string
        default: ci-<< pipeline.number >>-update
      terraform_version:
        type: string
    environment: *default_environment
    steps:
      - checkout
      - install_dependencies
      - install_package:
          package_name: git
      - install_terraform
      - set_env_vars
      - run:
          name: "Set module source to latest domino release"
          working_directory: tests
          command: |
            latest_tag="v2.5.0"
            export MOD_SOURCE="github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git?ref=${latest_tag}"
            echo "Latest published release tag is: ${latest_tag}"
            echo "Setting module source to: ${MOD_SOURCE}"
            mv modules.tf.json modules.ori
            jq --arg mod "$MOD_SOURCE" -e '.module.aks.source=$mod' modules.ori > modules.tf.json
      - tf_init_apply
      - run:
          name: "Upgrade module by applying this commit"
          working_directory: tests
          command: |
            echo "Testing terraform module upgrade"
            cp modules.ori modules.tf.json
            terraform init --reconfigure --upgrade
            terraform validate
            # https://github.com/hashicorp/terraform-provider-azurerm/issues/21805
            terraform apply --auto-approve || terraform apply --auto-approve
      - tf_destroy
      - tf_ws_delete

workflows:
  test-deploy-workflow:
    jobs:
      - pre-commit:
          terraform_version: << pipeline.parameters.terraform_version >>
      - test-deploy:
          terraform_version: << pipeline.parameters.terraform_version >>
          requires:
            - pre-commit
      - test-upgrade:
          terraform_version: << pipeline.parameters.terraform_version >>
          requires:
            - pre-commit
